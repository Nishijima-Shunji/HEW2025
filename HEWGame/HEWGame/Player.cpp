//*****************************************************************************
//!	@file	ファイル名
//!	@brief	簡単な説明
//!	@note	メモ
//!	@author	製作者
//*****************************************************************************

//-----------------------------------------------------------------------------
//	Include header files.
//-----------------------------------------------------------------------------
#include "Player.h"
#include "GameScene.h"

//-----------------------------------------------------------------------------
// プロトタイプ宣言
//-----------------------------------------------------------------------------


//-----------------------------------------------------------------------------
// グローバル変数
//-----------------------------------------------------------------------------


//==============================================================================
//!	@fn		
//!	@brief	
//!	@param	
//!	@param	
//!	@param	
//!	@param	
//!	@retval 
//==============================================================================

std::vector<std::vector<int>> Player::Update(std::vector<std::vector<int>> MapData, GameScene& game)
{
	Map = MapData;
	if (Start == false)
	{
		SetUp();
		CheckEdge();
		Start = true;
	}

	Move();


	Animation(game);

	// =====アニメーション=====
	

	return Map;
}

void Player::SetUp()//ステージ更新ごとに行う
{
	for (int i = 0; i < 18; i++) {
		for (int j = 0; j < 32; j++) {
			if (Map[i][j] == P_DIVER)
			{   //プレイヤーを登録

				MoveList[i][j] = P_DIVER;
				Map[i][j] = DARKNESS;

				X = i;
				Y = j;
				targetX = pos.x;
				targetY = pos.y;
			}
			else if (Map[i][j] == GOAL)
			{   //ゴールを登録

				MoveList[i][j] = GOAL;
				Goal_X = i;
				Goal_Y = j;
			}
			else if (Map[i][j] == MENDAKO)
			{   //メンダコを登録

				MoveList[i][j] = MENDAKO;
				Map[i][j] = DARKNESS;
			}
			else if (Map[i][j] == TRAP)
			{   //トラップを登録

				MoveList[i][j] = TRAP;
				Map[i][j] = DARKNESS;
			}
			else if (Map[i][j] == STREAM_R)
			{   //海流(右)を登録

				MoveList[i][j] = STREAM_R;
				Map[i][j] = DARKNESS;
			}
			else if (Map[i][j] == STREAM_L)
			{   //海流(左)を登録

				MoveList[i][j] = STREAM_L;
				Map[i][j] = DARKNESS;
			}
			else if (Map[i][j] == MOB_1)
			{   //オニキンメを登録

				MoveList[i][j] = MOB_1;
				Map[i][j] = DARKNESS;
			}
			else
			{
				//   MoveList[i][j] = SPACE;
			}
		}
	}
}


void Player::Move()
{
	DirectX::XMFLOAT3 pos = GetPos();

	if (Map[X][Y] == GOAL)
	{
		goalFlg = true;
	}

	if (targetX == pos.x && targetY == pos.y && moveState != 2)//移動が完了した and 移動可能状態
	{
		//ライトとの接触確認
		//照射中
		if (Map[X][Y] == LUMINOUS)
		{
			//上下マスの発光を確認
			if (Map[X - 1][Y] == LUMINOUS || Map[X + 1][Y] == LUMINOUS)
			{
				Vertical = true;
			}
			else
			{
				Vertical = false;
			}
			//左右マスの発光を確認
			if (Map[X][Y - 1] == LUMINOUS || Map[X][Y + 1] == LUMINOUS)
			{
				Horizontal = true;
			}
			else
			{
				Horizontal = false;
			}

			//上下移動
			if (Vertical == true)
			{
				if (Map[X - 1][Y] != LUMINOUS && Map[X - 1][Y] != GOAL)      //上のマスが発光していない
				{
					Reverse = false;
				}
				else if (Map[X + 1][Y] != LUMINOUS && Map[X + 1][Y] != GOAL) //下のマスが発光していない
				{
					Reverse = true;
				}

				if (Reverse == false)
				{
					targetY -= 30.0f;
					X += 1;
				}
				else if (Reverse == true)
				{
					targetY += 30.0f;
					X -= 1;
				}
			}

			//左右移動
			if (Horizontal == true)
			{
				if (Map[X][Y - 1] != LUMINOUS && Map[X][Y - 1] != GOAL)      //左のマスが発光していない
				{
					Reverse = false;
				}
				else if (Map[X][Y + 1] != LUMINOUS && Map[X][Y + 1] != GOAL) //右のマスが発光していない
				{
					Reverse = true;
				}
				if (Reverse == false)
				{
					targetX += 30.0f;
					Y += 1;
				}
				else if (Reverse == true)
				{
					targetX -= 30.0f;
					Y -= 1;
				}
			}
		}
		//非照射
		else
		{
			Vertical = false;
			Horizontal = false;
			Reverse = false;
		}

	}
	else//移動中
	{
		// 滑らかに目標座標へ移動
		//目標座標より上に存在
		if (pos.x < targetX)
		{
			pos.x += 1.0f;
		}
		//目標座標より下に存在
		else if (pos.x > targetX)
		{
			pos.x -= 1.0f;
		}
		//目標座標より右に存在
		else if (pos.y > targetY)
		{
			pos.y -= 1.0f;
		}
		//目標座標より左に存在
		else if (pos.y < targetY)
		{
			pos.y += 1.0f;
		}

		SetPos(pos.x, pos.y, pos.z);
	}
}

void Player::SetMoveState(int _state) {
	moveState = _state;
}

void Player::Animation(GameScene& game) {
	TextureManager* texture = game.GetTexture_ptr();
	// 上に移動するとき
	if (Vertical && Reverse) {
		SetTexture(texture, L"asset/survivor2.png", 4, 2);
	}
	// 横に移動するとき
	else if (Horizontal) {
		SetTexture(texture, L"asset/survivor1.png", 4, 2);
		if (Reverse) {
			direction = 0;
		}
		else {
			direction = 1;
		}
	}
	// 落下 or 待機状態
	else {
		SetTexture(texture, L"asset/survivor3.png", 4, 2);
	}
	// アニメーション
	SetUV(animcount % 4, (animcount / 4) % 2);
	if (framecount % 5 == 0) {
		animcount++;
	}

	framecount++;
}

void Player::CheckEdge()
{
	//横幅を取得
	for (int i = 0; i < WIDTH; i++) {
		if (Map[0][i] == NODATA) {
			width = i - 1;
			break;
		}
	}
	//高さを取得
	for (int j = 0; j < HEIGHT; j++) {
		if (Map[j][0] == NODATA) {
			height = j - 1;
			break;
		}
	}
}

//******************************************************************************
//	End of file.
//******************************************************************************
